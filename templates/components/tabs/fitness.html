<div x-show="currentTab === 'fitness'" class="max-w-6xl mx-auto space-y-6 animate-fade-in pb-24" x-cloak>

    <!-- Header -->
    <div class="flex justify-between items-center animate-slide-up delay-100">
        <div>
            <h2 class="text-3xl font-bold tracking-tight">Training Lab</h2>
            <p class="text-white/40 text-xs mt-1">Bio-Individualized Protocol</p>
        </div>
        <div class="flex gap-2">
             <button @click="openFitnessWizard" class="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 text-white text-xs font-bold border border-white/10 transition flex items-center gap-2">
                <span class="animate-spin-slow">‚ö°</span> Regenerate
             </button>
        </div>
    </div>

    <!-- Calendar Strip -->
    <div class="flex gap-2 overflow-x-auto custom-scroll snap-x py-2 animate-slide-up delay-200">
        <template x-for="day in calendarDays">
            <button @click="selectDate(day)"
                    class="flex-shrink-0 w-16 h-20 rounded-2xl flex flex-col items-center justify-center gap-0.5 transition-all duration-300 snap-center border group"
                    :class="day.active ? 'bg-brand-orange border-brand-orange text-white shadow-lg shadow-brand-orange/30 scale-105' : 'bg-white/5 border-transparent text-white/40 hover:bg-white/10 hover:text-white'">
                <span class="text-[10px] font-bold uppercase tracking-wider" x-text="day.day"></span>
                <span class="text-xl font-black" x-text="day.date"></span>
                <div x-show="day.isToday" class="w-1.5 h-1.5 rounded-full bg-white mt-1"></div>
            </button>
        </template>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-slide-up delay-300">

        <!-- Left: Workout Session -->
        <div class="lg:col-span-2 space-y-6">
             <template x-for="workout in workoutPlan">
                <div x-show="workout.day === calendarDays.find(d => d.active)?.day" class="animate-scale-in space-y-6">

                    <!-- Workout Header Card -->
                    <div class="glass-card p-8 rounded-[32px] relative overflow-hidden bg-gradient-to-br from-brand-orange/10 to-transparent border border-brand-orange/20">
                        <div class="absolute top-0 right-0 w-64 h-64 bg-brand-orange/20 blur-[80px] rounded-full pointer-events-none mix-blend-screen"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-4">
                                <div class="px-3 py-1 rounded-full bg-brand-orange/20 text-brand-orange text-[10px] font-bold uppercase tracking-wider border border-brand-orange/20" x-text="workout.focus"></div>
                                <div class="text-xs text-white/50 font-mono tracking-wide" x-text="workout.benefit"></div>
                            </div>
                            <h3 class="text-4xl font-black text-white mb-4">Today's Session</h3>
                            <div class="flex gap-6 text-xs text-white/60 font-medium">
                                <div class="flex items-center gap-2"><span class="text-brand-orange">‚è±Ô∏è</span> 60m Est.</div>
                                <div class="flex items-center gap-2"><span class="text-brand-orange">üî•</span> 450 Kcal</div>
                                <div class="flex items-center gap-2"><span class="text-brand-orange">üìä</span> <span x-text="calculateSessionVolume(workout) + ' kg Vol'"></span></div>
                            </div>
                        </div>

                        <!-- Warmup Mini-Section -->
                         <template x-if="workout.warmup && workout.warmup.length">
                            <div class="mt-8 pt-6 border-t border-white/10">
                                <div class="text-[10px] font-bold text-white/30 uppercase mb-3 tracking-widest">Warm Up Protocol</div>
                                <div class="flex flex-wrap gap-2">
                                    <template x-for="warm in workout.warmup">
                                        <div class="px-3 py-1.5 rounded-lg bg-white/5 border border-white/10 text-xs text-white/80" x-text="warm"></div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Exercises List -->
                    <div class="space-y-4">
                        <template x-for="(ex, exIdx) in workout.exercises">
                            <div class="glass-card rounded-[24px] overflow-hidden border border-white/5 transition hover:border-white/10" x-data="{ expanded: true }">
                                <!-- Exercise Header -->
                                <div class="p-5 bg-white/5 flex justify-between items-center cursor-pointer hover:bg-white/10 transition" @click="expanded = !expanded">
                                    <div class="flex items-center gap-4">
                                        <div class="w-8 h-8 rounded-xl bg-brand-orange/10 text-brand-orange flex items-center justify-center text-sm font-bold shadow-[0_0_10px_rgba(249,115,22,0.1)]" x-text="exIdx + 1"></div>
                                        <div>
                                            <div class="font-bold text-base" x-text="ex.name || ex"></div>
                                            <div class="text-xs text-white/40 font-mono mt-0.5" x-text="(ex.setLogs.length) + ' Sets ‚Ä¢ Target: ' + (ex.reps || '8-12') + ' Reps'"></div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <div x-show="getExerciseHistory(ex.name)" class="hidden sm:block text-[10px] px-2 py-1 rounded bg-blue-500/10 text-blue-400 border border-blue-500/20 font-mono">
                                            PR: <span x-text="getExerciseHistory(ex.name)"></span>
                                        </div>
                                        <div class="transform transition-transform text-white/40" :class="expanded ? 'rotate-180' : ''">‚ñº</div>
                                    </div>
                                </div>

                                <!-- Exercise Details (Sets) -->
                                <div x-show="expanded" class="p-5 bg-black/20" x-collapse>
                                    <div class="space-y-2">
                                        <!-- Header Row -->
                                        <div class="grid grid-cols-10 gap-3 text-[10px] text-white/30 font-bold uppercase tracking-wider text-center mb-2">
                                            <div class="col-span-1">Set</div>
                                            <div class="col-span-3">Prev</div>
                                            <div class="col-span-2">Kg</div>
                                            <div class="col-span-2">Reps</div>
                                            <div class="col-span-2">Done</div>
                                        </div>

                                        <!-- Set Rows -->
                                        <template x-for="(set, setIdx) in ex.setLogs">
                                            <div class="grid grid-cols-10 gap-3 items-center transition-opacity duration-300" :class="set.completed ? 'opacity-40' : ''">
                                                <div class="col-span-1 flex justify-center">
                                                    <div class="w-6 h-6 rounded bg-white/5 flex items-center justify-center text-[10px] text-white/50 font-mono" x-text="setIdx + 1"></div>
                                                </div>
                                                <div class="col-span-3 text-center">
                                                    <div class="text-[10px] text-white/30 font-mono" x-text="getExerciseHistory(ex.name) || '-'"></div>
                                                </div>
                                                <div class="col-span-2">
                                                    <input type="number" x-model="set.weight" placeholder="0" class="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-1.5 text-sm text-center focus:border-brand-orange focus:ring-1 focus:ring-brand-orange focus:outline-none transition-colors">
                                                </div>
                                                <div class="col-span-2">
                                                    <input type="number" x-model="set.reps" placeholder="0" class="w-full bg-white/5 border border-white/10 rounded-lg px-2 py-1.5 text-sm text-center focus:border-brand-orange focus:ring-1 focus:ring-brand-orange focus:outline-none transition-colors">
                                                </div>
                                                <div class="col-span-2 flex justify-center">
                                                    <button @click="toggleSet(ex, setIdx); if(set.completed) startRest(90);" class="w-8 h-8 rounded-lg border transition-all flex items-center justify-center transform active:scale-95"
                                                            :class="set.completed ? 'bg-green-500 border-green-500 text-white shadow-[0_0_10px_#22c55e]' : 'border-white/10 bg-white/5 hover:border-brand-orange hover:text-brand-orange text-white/20'">
                                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M5 13l4 4L19 7"></path></svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </template>
                                    </div>

                                    <!-- Tip and Rest -->
                                    <div class="mt-4 pt-4 border-t border-white/5 flex justify-between items-center">
                                        <div class="flex items-center gap-2 text-xs text-white/50 italic">
                                            <span class="text-brand-orange not-italic">üí°</span>
                                            <span class="truncate max-w-[200px]" x-text="ex.tip || 'Keep core tight'"></span>
                                        </div>
                                        <button @click="startRest(90)" class="text-xs text-brand-orange hover:text-orange-300 font-bold flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-brand-orange/10 transition">
                                            <span>‚è±Ô∏è</span> Rest 90s
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Finish Workout -->
                    <div class="pt-6 pb-12">
                         <button @click="finishWorkout(workout)" class="w-full py-4 rounded-2xl bg-gradient-to-r from-brand-emerald to-green-600 hover:from-green-400 hover:to-green-500 text-white font-bold shadow-lg shadow-green-900/20 transition-all transform hover:scale-[1.01] hover:-translate-y-1">
                             Finish Workout & Save Progress
                         </button>
                    </div>

                </div>
             </template>

             <!-- Empty State -->
             <div x-show="!workoutPlan.length" class="py-20 text-center text-white/40 border border-dashed border-white/10 rounded-[32px] bg-white/[0.02]">
                <div class="text-5xl mb-6 grayscale opacity-50">üèãÔ∏è</div>
                <h3 class="text-xl font-bold text-white mb-2">No Plan Active</h3>
                <p class="text-sm mb-8 max-w-xs mx-auto">Create a new split based on your biomarkers to get started.</p>
                <button @click="openFitnessWizard" class="px-8 py-3 rounded-xl bg-brand-orange text-white font-bold hover:bg-orange-500 transition shadow-lg shadow-brand-orange/20">Create Plan</button>
             </div>
        </div>

        <!-- Right: Sidebar & Tools -->
        <div class="space-y-6">

            <!-- Recovery Card -->
            <div class="glass-card p-6 rounded-[24px]">
                <h4 class="font-bold text-xs text-white/40 mb-4 uppercase tracking-wider">Recovery Status</h4>
                <div class="flex items-end gap-3 mb-3">
                    <div class="text-4xl font-bold text-brand-emerald">92%</div>
                    <div class="text-xs text-white/40 mb-1.5 font-bold uppercase">Recovered</div>
                </div>
                <div class="w-full h-2 bg-white/10 rounded-full overflow-hidden">
                    <div class="w-[92%] h-full bg-brand-emerald rounded-full shadow-[0_0_10px_#10b981]"></div>
                </div>
                <p class="text-[10px] text-white/40 mt-4 leading-relaxed">HRV is optimal. You are ready for high intensity output today.</p>
            </div>

            <!-- Body Focus Visualization -->
            <div class="glass-card p-6 rounded-[24px]" x-show="getNextWorkout()">
                <h4 class="font-bold text-xs text-white/40 mb-4 uppercase tracking-wider">Target Muscles</h4>
                <div class="relative h-56 w-full bg-black/30 rounded-2xl border border-white/5 overflow-hidden flex items-center justify-center">
                    <!-- Simple CSS Body Viz -->
                    <div class="grid grid-cols-2 gap-1 w-32 opacity-80 scale-110">
                         <div class="h-8 rounded bg-white/10 flex items-center justify-center text-[8px] transition-colors" :class="isMuscleActive('Shoulders') ? 'bg-brand-orange text-white shadow-[0_0_10px_#f97316]' : ''">Shoulders</div>
                         <div class="h-8 rounded bg-white/10 flex items-center justify-center text-[8px] transition-colors" :class="isMuscleActive('Shoulders') ? 'bg-brand-orange text-white shadow-[0_0_10px_#f97316]' : ''">Shoulders</div>

                         <div class="h-12 col-span-2 rounded bg-white/10 flex items-center justify-center text-[8px] transition-colors" :class="isMuscleActive('Chest') ? 'bg-brand-orange text-white shadow-[0_0_10px_#f97316]' : ''">Chest / Back</div>

                         <div class="h-10 rounded bg-white/10 flex items-center justify-center text-[8px] transition-colors" :class="isMuscleActive('Arms') ? 'bg-brand-orange text-white shadow-[0_0_10px_#f97316]' : ''">Arm</div>
                         <div class="h-10 rounded bg-white/10 flex items-center justify-center text-[8px] transition-colors" :class="isMuscleActive('Arms') ? 'bg-brand-orange text-white shadow-[0_0_10px_#f97316]' : ''">Arm</div>

                         <div class="h-8 col-span-2 rounded bg-white/10 flex items-center justify-center text-[8px] transition-colors" :class="isMuscleActive('Core') ? 'bg-brand-orange text-white shadow-[0_0_10px_#f97316]' : ''">Abs / Core</div>

                         <div class="h-14 rounded bg-white/10 flex items-center justify-center text-[8px] transition-colors" :class="isMuscleActive('Legs') ? 'bg-brand-orange text-white shadow-[0_0_10px_#f97316]' : ''">Leg</div>
                         <div class="h-14 rounded bg-white/10 flex items-center justify-center text-[8px] transition-colors" :class="isMuscleActive('Legs') ? 'bg-brand-orange text-white shadow-[0_0_10px_#f97316]' : ''">Leg</div>
                    </div>
                </div>
                <div class="mt-4 text-center">
                    <span class="px-3 py-1 rounded-full bg-white/5 border border-white/5 text-[10px] text-white/60 font-mono">Focus: <span x-text="getNextWorkout()?.focus || 'Rest'" class="text-white font-bold"></span></span>
                </div>
            </div>

            <!-- Volume Chart -->
            <div class="glass-card p-6 rounded-[24px]">
                 <h4 class="font-bold text-xs text-white/40 mb-4 uppercase tracking-wider">Weekly Volume (Kg)</h4>
                 <div class="h-32 w-full">
                     <canvas id="fitnessVolumeChart"></canvas>
                 </div>
            </div>

            <!-- Tools Grid -->
            <div>
                <h4 class="font-bold text-xs text-white/40 mb-4 uppercase tracking-wider">Tools</h4>
                <div class="grid grid-cols-2 gap-3">
                    <template x-for="tool in fitnessTools">
                        <button @click="openFitnessTool(tool)" class="glass-card p-4 rounded-2xl text-left hover:bg-white/5 transition border border-white/5 hover:border-white/10 hover:-translate-y-0.5 group">
                            <div class="text-2xl mb-2 grayscale group-hover:grayscale-0 transition-all" x-text="tool.icon || 'üõ†Ô∏è'"></div>
                            <div class="font-bold text-xs truncate text-white/70 group-hover:text-white" x-text="tool.name"></div>
                        </button>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>