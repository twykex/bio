<div x-show="currentTab === 'nutrition'" class="max-w-7xl mx-auto space-y-8 animate-scale-in pb-20">

    <!-- HEADER -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
            <div class="flex items-center gap-2 mb-1">
                <span class="px-2 py-0.5 rounded-full bg-blue-500/20 text-blue-400 text-[10px] font-bold uppercase tracking-wider">Beta</span>
                <span class="text-xs text-white/40 uppercase tracking-widest">Nutrition Architect</span>
            </div>
            <h2 class="text-4xl font-bold bg-gradient-to-r from-white to-white/50 bg-clip-text text-transparent">Fuel Your Body</h2>
        </div>
        <div class="flex gap-3 w-full md:w-auto">
            <button @click="generateShoppingList" class="flex-1 md:flex-none px-5 py-3 rounded-2xl bg-white/5 hover:bg-white/10 text-xs font-bold transition border border-white/5 flex items-center justify-center gap-2 group">
                <span class="text-lg group-hover:-rotate-12 transition">üõí</span> <span>Shopping List</span>
            </button>
            <button @click="openMealWizard" class="flex-1 md:flex-none px-5 py-3 rounded-2xl bg-[#3b82f6] hover:bg-blue-500 text-white text-xs font-bold transition shadow-lg shadow-blue-900/20 flex items-center justify-center gap-2 group">
                <span class="text-lg animate-pulse">‚ú®</span> <span>Plan New Week</span>
            </button>
        </div>
    </div>

    <!-- MAIN GRID -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

        <!-- LEFT COLUMN (Main Content) -->
        <div class="lg:col-span-8 space-y-6">

            <!-- DATE STRIP -->
            <div class="glass-panel p-2 rounded-[24px] flex gap-2 overflow-x-auto custom-scroll snap-x">
                <template x-for="day in calendarDays">
                    <button @click="selectDate(day)"
                            class="flex-shrink-0 w-16 h-24 rounded-2xl flex flex-col items-center justify-center gap-1 transition-all duration-300 snap-center border relative overflow-hidden"
                            :class="day.active ? 'bg-blue-600 border-blue-500 text-white shadow-xl shadow-blue-900/30 scale-100 z-10' : 'bg-white/5 border-transparent text-white/40 hover:bg-white/10 hover:text-white'">
                        <span class="text-[10px] font-bold uppercase tracking-wider" x-text="day.day"></span>
                        <span class="text-2xl font-black tracking-tighter" x-text="day.date"></span>

                        <!-- Status Dot -->
                        <div class="w-1.5 h-1.5 rounded-full mt-2"
                             :class="day.active ? 'bg-white' : (weekPlan.find(d => d.date === day.fullDate) ? 'bg-blue-500' : 'bg-transparent')"></div>

                        <!-- Today Indicator -->
                        <div x-show="day.isToday" class="absolute top-1 right-1 w-2 h-2 rounded-full bg-red-500 shadow-lg shadow-red-500/50"></div>
                    </button>
                </template>
            </div>

            <!-- MEAL FEED -->
            <div class="min-h-[400px]">

                <!-- EMPTY STATE -->
                <div x-show="weekPlan.length === 0" class="flex flex-col items-center justify-center h-96 text-center border border-dashed border-white/10 rounded-[32px] bg-white/[0.02]">
                    <div class="w-20 h-20 rounded-full bg-gradient-to-tr from-blue-500/20 to-purple-500/20 flex items-center justify-center mb-6 text-4xl animate-float">ü•ó</div>
                    <h3 class="text-xl font-bold text-white mb-2">No Protocol Active</h3>
                    <p class="text-white/40 text-sm max-w-md mx-auto mb-8">Your nutrition journey starts here. Use the Architect to design a custom meal plan based on your biology.</p>
                    <button @click="openMealWizard" class="px-8 py-4 rounded-full bg-white text-black font-bold text-sm hover:scale-105 transition shadow-xl shadow-white/10">Launch Architect</button>
                </div>

                <!-- ACTIVE STATE -->
                <div x-show="weekPlan.length > 0">
                    <template x-for="daily in getMealsForSelectedDate()">
                        <div class="space-y-6 animate-scale-in">

                            <!-- MEAL LIST HEADER -->
                            <div class="flex items-center justify-between pl-1">
                                <h3 class="text-sm font-bold text-white/60 flex items-center gap-2">
                                    <span>üçΩÔ∏è</span> Scheduled Meals
                                </h3>
                                <button @click="openAddMealModal(daily)" class="px-3 py-1.5 rounded-lg bg-blue-500/10 text-blue-400 text-[10px] font-bold hover:bg-blue-500 hover:text-white transition flex items-center gap-1">
                                    <span>+</span> Add Entry
                                </button>
                            </div>

                            <!-- MEAL CARDS -->
                            <div class="space-y-4">
                                <template x-for="meal in daily.meals">
                                    <div class="glass-card p-0 rounded-[24px] overflow-hidden group hover:border-blue-500/30 transition-all duration-300 relative"
                                         :class="meal.completed ? 'bg-blue-900/5' : 'bg-white/[0.02]'">

                                        <!-- Completion Overlay (Subtle) -->
                                        <div class="absolute inset-0 bg-black/40 pointer-events-none transition-opacity duration-300"
                                             :class="meal.completed ? 'opacity-100' : 'opacity-0'"></div>

                                        <div class="flex flex-col sm:flex-row items-stretch relative z-10">

                                            <!-- Checkbox Area -->
                                            <div @click="toggleMealCompletion(meal)" class="sm:w-20 bg-white/5 flex items-center justify-center cursor-pointer hover:bg-green-500/20 transition-colors border-b sm:border-b-0 sm:border-r border-white/5 h-16 sm:h-auto">
                                                <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all duration-300"
                                                     :class="meal.completed ? 'bg-green-500 border-green-500 scale-110' : 'border-white/20 group-hover:border-white'">
                                                    <svg x-show="meal.completed" class="w-4 h-4 text-black font-bold" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="4"><path d="M5 13l4 4L19 7"></path></svg>
                                                </div>
                                            </div>

                                            <!-- Content -->
                                            <div class="flex-1 p-5 flex flex-col justify-between gap-4">
                                                <div>
                                                    <div class="flex flex-wrap items-center gap-2 mb-2">
                                                        <span class="px-2 py-1 rounded-md text-[10px] font-bold uppercase tracking-wider flex items-center gap-1"
                                                              :class="meal.completed ? 'bg-white/10 text-white/50' : 'bg-blue-500/20 text-blue-400'">
                                                            <span x-text="getMealIcon(meal.type)"></span>
                                                            <span x-text="meal.type"></span>
                                                        </span>
                                                        <span class="text-xs text-white/40 font-mono" x-text="meal.calories + ' kcal'"></span>
                                                    </div>

                                                    <h3 class="text-lg font-bold text-white mb-1 group-hover:text-blue-400 transition"
                                                        x-text="meal.title"
                                                        :class="meal.completed ? 'line-through text-white/30' : ''"></h3>

                                                    <p class="text-[10px] text-white/40 uppercase tracking-widest line-clamp-1" x-text="meal.benefit"></p>
                                                </div>

                                                <!-- Macros & Actions Row -->
                                                <div class="flex flex-col sm:flex-row sm:items-end justify-between gap-4">

                                                    <!-- Macros -->
                                                    <div class="flex gap-4" :class="meal.completed ? 'opacity-30' : ''">
                                                        <div class="flex flex-col">
                                                            <span class="text-[10px] text-white/30 uppercase">PRO</span>
                                                            <span class="text-xs font-bold text-blue-400" x-text="meal.protein"></span>
                                                        </div>
                                                        <div class="flex flex-col">
                                                            <span class="text-[10px] text-white/30 uppercase">CARB</span>
                                                            <span class="text-xs font-bold text-green-400" x-text="meal.carbs"></span>
                                                        </div>
                                                        <div class="flex flex-col">
                                                            <span class="text-[10px] text-white/30 uppercase">FAT</span>
                                                            <span class="text-xs font-bold text-orange-400" x-text="meal.fats"></span>
                                                        </div>
                                                    </div>

                                                    <!-- Actions -->
                                                    <div class="flex items-center gap-2">
                                                        <button @click.stop="openRecipe(meal)" class="px-4 py-2 rounded-lg bg-white/5 hover:bg-white text-white hover:text-black text-xs font-bold transition flex items-center gap-2">
                                                            <span>üìú</span> Recipe
                                                        </button>
                                                        <button @click.stop="openMealNotes(meal)" class="w-8 h-8 rounded-lg bg-white/5 hover:bg-white/20 flex items-center justify-center transition text-white/50 hover:text-white">
                                                            üìù
                                                        </button>
                                                    </div>
                                                </div>

                                                <!-- Notes Preview -->
                                                <div x-show="meal.notes" class="mt-2 p-2 rounded-lg bg-yellow-500/10 border border-yellow-500/20 flex items-start gap-2">
                                                    <span class="text-yellow-500 text-xs mt-0.5">üìù</span>
                                                    <span class="text-xs text-yellow-200/80 italic" x-text="meal.notes"></span>
                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>

                        </div>
                    </template>
                </div>
            </div>

        </div>

        <!-- RIGHT COLUMN (Sidebar Stats) -->
        <div class="lg:col-span-4 space-y-6">

            <!-- DAILY SNAPSHOT CARD -->
            <div x-show="weekPlan.length > 0" class="glass-card p-6 rounded-[32px] relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500/20 blur-[60px] rounded-full pointer-events-none"></div>

                <h3 class="text-xs font-bold text-white/40 uppercase tracking-widest mb-6 flex items-center gap-2">
                    <span>üìä</span> Daily Vitality
                </h3>

                <template x-for="daily in getMealsForSelectedDate()">
                    <div class="space-y-8">

                        <!-- CALORIE CIRCLE -->
                        <div class="flex items-center justify-center relative">
                            <!-- Background Circle -->
                            <div class="w-40 h-40 rounded-full border-[10px] border-white/5 flex items-center justify-center relative">
                                <div class="text-center z-10">
                                    <div class="text-3xl font-black text-white" x-text="daily.total_macros.calories"></div>
                                    <div class="text-[10px] font-bold text-white/40 uppercase tracking-widest">Kcal</div>
                                </div>

                                <!-- Chart Overlay -->
                                <div class="absolute inset-[-10px]">
                                    <canvas id="dailyMacrosChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- MACRO BARS -->
                        <div class="space-y-3">
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-blue-400 font-bold">Protein</span>
                                    <span class="text-white font-mono" x-text="daily.total_macros.protein"></span>
                                </div>
                                <div class="w-full h-1.5 bg-white/5 rounded-full overflow-hidden">
                                    <div class="h-full bg-blue-500 rounded-full" style="width: 40%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-green-400 font-bold">Carbs</span>
                                    <span class="text-white font-mono" x-text="daily.total_macros.carbs"></span>
                                </div>
                                <div class="w-full h-1.5 bg-white/5 rounded-full overflow-hidden">
                                    <div class="h-full bg-green-500 rounded-full" style="width: 50%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-orange-400 font-bold">Fats</span>
                                    <span class="text-white font-mono" x-text="daily.total_macros.fats"></span>
                                </div>
                                <div class="w-full h-1.5 bg-white/5 rounded-full overflow-hidden">
                                    <div class="h-full bg-orange-500 rounded-full" style="width: 30%"></div>
                                </div>
                            </div>
                        </div>

                    </div>
                </template>
            </div>

            <!-- HYDRATION CARD -->
            <div x-show="weekPlan.length > 0" class="glass-card p-6 rounded-[32px] bg-gradient-to-b from-blue-900/10 to-transparent border-blue-500/10">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xs font-bold text-blue-400 uppercase tracking-widest">Hydration</h3>
                    <div class="px-2 py-0.5 rounded text-[10px] bg-blue-500 text-white font-bold" x-text="Math.round((waterIntake/waterGoal)*100) + '%'"></div>
                </div>

                <div class="flex items-end justify-between mb-6">
                    <div>
                         <span class="text-4xl font-black text-white" x-text="waterIntake"></span>
                         <span class="text-sm text-white/40 font-bold">/ <span x-text="waterGoal"></span></span>
                         <div class="text-[10px] text-white/40 uppercase mt-1">Glasses (250ml)</div>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-blue-500/20 flex items-center justify-center text-xl animate-pulse">üíß</div>
                </div>

                <!-- Water Controls -->
                <div class="grid grid-cols-2 gap-3">
                    <button @click="resetWater" class="py-3 rounded-xl bg-white/5 hover:bg-white/10 text-white/40 hover:text-red-400 text-xs font-bold transition">
                        Reset
                    </button>
                    <button @click="addWater" class="py-3 rounded-xl bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold shadow-lg shadow-blue-900/30 active:scale-95 transition">
                        + Add Glass
                    </button>
                </div>
            </div>

            <!-- TOOLS GRID (Mini) -->
            <div>
                 <h3 class="text-xs font-bold text-white/40 uppercase tracking-widest mb-4 flex items-center justify-between">
                     <span>üß∞ Quick Tools</span>
                     <span class="text-[10px] bg-white/5 px-2 py-0.5 rounded cursor-pointer hover:bg-white/10" @click="bioHacksOpen = true">View All</span>
                 </h3>
                 <div class="grid grid-cols-4 gap-2">
                     <template x-for="tool in getNutritionTools().slice(0, 8)">
                        <button @click="selectTool(tool); bioHacksOpen = true"
                                class="aspect-square rounded-2xl bg-white/5 hover:bg-white/10 border border-white/5 hover:border-white/20 transition flex items-center justify-center text-xl group relative"
                                :title="tool.name">
                            <span class="group-hover:scale-125 transition duration-300" x-text="getToolIcon(tool.id)"></span>
                        </button>
                     </template>
                 </div>
            </div>

            <!-- TREND CHART -->
            <div x-show="weekPlan.length > 0" class="glass-card p-5 rounded-[24px]">
                <h3 class="text-[10px] font-bold text-white/30 uppercase tracking-widest mb-3">Weekly Calorie Trend</h3>
                <div class="h-24 w-full">
                    <canvas id="weeklyCalorieChart"></canvas>
                </div>
            </div>

        </div>
    </div>
</div>