<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIO-OS // System Interface</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: {
                        bio: { 900: '#0c0c0e', 800: '#131316', accent: '#F59E0B' }
                    },
                    backgroundImage: {
                        'grid-pattern': "linear-gradient(to right, #202020 1px, transparent 1px), linear-gradient(to bottom, #202020 1px, transparent 1px)",
                    },
                    animation: {
                        'scan': 'scanline 3s linear infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #050505; color: #e5e5e5; }
        .bg-tech-grid {
            background-size: 40px 40px;
            background-image: linear-gradient(to right, rgba(255,255,255,0.03) 1px, transparent 1px),
                              linear-gradient(to bottom, rgba(255,255,255,0.03) 1px, transparent 1px);
            mask-image: radial-gradient(circle at center, black 40%, transparent 100%);
        }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #0c0c0e; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #555; }

        @keyframes scanline {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        [x-cloak] { display: none !important; }

        .glass-panel {
            background: rgba(15, 15, 18, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        .toast-enter { animation: slideIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden relative font-sans selection:bg-amber-500/30" x-data="app()">

    <div class="absolute inset-0 bg-tech-grid z-0 pointer-events-none"></div>
    <div class="absolute inset-0 bg-gradient-to-b from-transparent via-black/40 to-black z-0 pointer-events-none"></div>

    <header class="h-14 border-b border-white/10 flex items-center justify-between px-6 bg-bio-900/90 backdrop-blur-md z-40 relative">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 cursor-pointer" @click="resetSystem" title="Reset System">
                <div class="w-2 h-2 bg-amber-500 rounded-full shadow-[0_0_8px_rgba(245,158,11,0.8)]"></div>
                <h1 class="text-lg font-bold tracking-tight text-white hover:text-amber-500 transition-colors">BIO<span class="text-white/40 font-light">OS</span></h1>
            </div>
            <div class="hidden md:flex items-center gap-2 text-[10px] font-mono uppercase tracking-wider text-white/30">
                <div class="h-4 w-[1px] bg-white/10 mx-2"></div>
                <span :class="!context ? 'text-amber-500' : ''">Input</span>
                <span>→</span>
                <span :class="context && weekPlan.length === 0 ? 'text-amber-500' : ''">Analysis</span>
                <span>→</span>
                <span :class="weekPlan.length > 0 ? 'text-amber-500' : ''">Protocol</span>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <template x-if="weekPlan.length > 0">
                <div class="flex gap-2">
                    <button @click="generateShoppingList"
                        class="px-3 py-1.5 rounded bg-white/5 border border-white/10 hover:bg-white/10 text-[10px] font-mono uppercase tracking-wider transition-all flex items-center gap-2 group">
                        <span class="group-hover:text-amber-500 transition-colors">Logistics</span>
                    </button>
                    <button @click="chatOpen = !chatOpen"
                        class="px-3 py-1.5 rounded border border-amber-500/30 bg-amber-500/10 hover:bg-amber-500/20 text-amber-500 text-[10px] font-mono uppercase tracking-wider transition-all flex items-center gap-2 shadow-[0_0_15px_rgba(245,158,11,0.1)]">
                        <span>Architect</span>
                        <span class="relative flex h-2 w-2">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-amber-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-2 w-2 bg-amber-500"></span>
                        </span>
                    </button>
                </div>
            </template>
        </div>
    </header>

    <main class="relative z-10 h-[calc(100vh-3.5rem)] flex flex-col items-center justify-center p-6">

        <div x-show="!context && !loading" class="w-full max-w-lg" x-transition.opacity.duration.500ms>
            <div class="glass-panel h-80 rounded-2xl relative overflow-hidden group transition-all duration-300"
                 @dragover.prevent="dragOver = true"
                 @dragleave="dragOver = false"
                 @drop.prevent="handleDrop($event)"
                 :class="dragOver ? 'border-amber-500 bg-amber-500/5' : 'border-white/10 hover:border-white/20'">

                <input type="file" id="fileUpload" class="hidden" @change="uploadData($event.target.files[0])">

                <label for="fileUpload" class="absolute inset-0 cursor-pointer flex flex-col items-center justify-center z-20">
                    <div class="w-20 h-20 rounded-full border border-white/10 bg-[#0c0c0e] flex items-center justify-center mb-6 group-hover:scale-110 group-hover:border-amber-500/50 transition-all duration-500 shadow-xl">
                        <svg class="w-8 h-8 text-white/30 group-hover:text-amber-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    </div>
                    <h2 class="text-2xl font-bold mb-2 group-hover:text-white transition-colors text-white/90">Initialize Context</h2>
                    <p class="text-xs font-mono text-white/40 uppercase tracking-widest" :class="dragOver ? 'text-amber-500' : ''">
                        <span x-text="dragOver ? 'Release to Upload' : 'Drop Blood Panel PDF'"></span>
                    </p>
                </label>

                <div class="absolute left-0 right-0 h-[2px] bg-amber-500 shadow-[0_0_15px_rgba(245,158,11,0.8)] z-10 animate-scan pointer-events-none opacity-50"></div>

                <div class="absolute inset-0 bg-[linear-gradient(rgba(255,255,255,0.02)_1px,transparent_1px),linear-gradient(90deg,rgba(255,255,255,0.02)_1px,transparent_1px)] bg-[size:20px_20px] pointer-events-none"></div>
            </div>
            <div class="text-center mt-6">
                <p class="text-[10px] text-white/20 font-mono">SECURE UPLOAD // ENCRYPTED // LOCAL PROCESSING</p>
            </div>
        </div>

        <div x-show="context && weekPlan.length === 0 && !loading" class="w-full max-w-6xl" x-cloak x-transition:enter="transition ease-out duration-500" x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0">
            <div class="mb-10 flex items-end justify-between border-b border-white/5 pb-6">
                <div>
                    <h2 class="text-3xl font-bold mb-2">Analysis Complete</h2>
                    <p class="text-sm text-white/50 font-mono max-w-2xl" x-text="context?.summary || 'Biomarkers analyzed. Select a protocol to proceed.'"></p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <template x-for="(strat, idx) in context?.strategies">
                    <button @click="generateWeek(strat.name)"
                            class="glass-panel p-8 rounded-xl text-left hover:-translate-y-2 hover:border-amber-500/40 transition-all duration-300 group relative overflow-hidden flex flex-col h-[320px]">

                        <div class="absolute top-0 right-0 p-6 opacity-20 group-hover:opacity-100 transition-opacity">
                            <span class="text-5xl font-bold text-white/5 font-mono group-hover:text-amber-500/10" x-text="'0' + (idx+1)"></span>
                        </div>

                        <div class="text-[10px] text-amber-500 font-mono uppercase tracking-widest mb-6 flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-amber-500"></span> Detected Path
                        </div>

                        <h3 class="text-2xl font-bold mb-4 group-hover:text-white transition-colors text-white/90" x-text="strat.name"></h3>
                        <p class="text-sm text-white/50 leading-relaxed flex-1" x-text="strat.desc"></p>

                        <div class="pt-6 mt-6 border-t border-white/5 flex items-center justify-between group-hover:border-white/10 transition-colors">
                            <span class="text-[10px] font-mono text-white/30 group-hover:text-white/60">GENERATE PROTOCOL</span>
                            <span class="text-lg text-amber-500 opacity-0 -translate-x-4 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-300">→</span>
                        </div>
                    </button>
                </template>
            </div>
        </div>

        <div x-show="loading" class="flex flex-col items-center justify-center text-center w-full max-w-md" x-transition.opacity>
            <div class="w-full h-1 bg-white/5 rounded-full overflow-hidden mb-6 relative">
                <div class="absolute inset-0 bg-amber-500/20 animate-pulse"></div>
                <div class="h-full bg-amber-500 animate-[width_2s_ease-in-out_infinite]" style="width: 30%"></div>
            </div>

            <div class="space-y-2">
                <div class="font-mono text-sm text-amber-500 uppercase tracking-widest" x-text="loadingText"></div>
                <div class="flex gap-1 justify-center">
                    <span class="w-1 h-1 bg-white/20 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
                    <span class="w-1 h-1 bg-white/20 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
                    <span class="w-1 h-1 bg-white/20 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
                </div>
            </div>
        </div>

        <div x-show="weekPlan.length > 0" class="w-full h-full flex flex-col animate-fadeIn" x-cloak>
            <div class="flex-1 overflow-x-auto custom-scroll flex items-center gap-6 px-8 py-8">
                <template x-for="(day, index) in weekPlan">
                    <div class="min-w-[340px] w-[340px] h-[520px] glass-panel rounded-2xl flex flex-col relative group hover:border-white/20 transition-all duration-300 snap-center">

                        <div class="h-36 w-full bg-[#1a1a1e] rounded-t-2xl relative overflow-hidden border-b border-white/5 group-hover:border-white/10 transition-colors">
                             <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-amber-900/20 via-[#1a1a1e] to-[#1a1a1e]"></div>
                             <div class="absolute top-4 left-4">
                                <span class="text-[10px] font-mono bg-black/40 backdrop-blur border border-white/10 px-2 py-1 rounded text-white/60" x-text="day.day"></span>
                             </div>
                        </div>

                        <div class="p-6 flex flex-col flex-1">
                            <h3 class="text-xl font-bold leading-tight mb-2 text-white/90 group-hover:text-white transition-colors" x-text="day.title"></h3>
                            <p class="text-xs text-white/40 mb-6 leading-relaxed line-clamp-3" x-text="day.benefit"></p>

                            <div class="flex flex-wrap gap-2 mb-auto">
                                <template x-for="ing in day.ingredients">
                                    <button class="text-[10px] font-mono px-2 py-1 rounded bg-white/5 border border-white/5 text-white/50 hover:border-amber-500/50 hover:text-amber-500 hover:bg-amber-500/10 transition-all cursor-pointer"
                                          @click.stop="quickSwap(day, ing)"
                                          title="Ask Architect for alternative">
                                        <span x-text="ing"></span>
                                    </button>
                                </template>
                            </div>

                            <div class="mt-6 pt-4 border-t border-white/5 flex justify-between items-center">
                                <button @click="openRecipe(day)" class="text-xs font-bold text-white/40 hover:text-white transition-colors flex items-center gap-2">
                                    DETAILS <span class="text-amber-500">↗</span>
                                </button>
                                <div class="flex gap-1">
                                    <div class="w-1 h-4 bg-emerald-500/20 rounded-full"></div>
                                    <div class="w-1 h-3 bg-blue-500/20 rounded-full"></div>
                                    <div class="w-1 h-5 bg-amber-500/20 rounded-full"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </main>

    <div class="fixed bottom-6 right-6 z-[60] flex flex-col gap-2 pointer-events-none">
        <template x-for="toast in toasts" :key="toast.id">
            <div class="glass-panel px-4 py-3 rounded-lg border-l-2 shadow-2xl flex items-center gap-3 min-w-[300px] toast-enter pointer-events-auto"
                 :class="toast.type === 'error' ? 'border-l-red-500' : 'border-l-emerald-500'">
                <div class="w-2 h-2 rounded-full" :class="toast.type === 'error' ? 'bg-red-500' : 'bg-emerald-500'"></div>
                <div>
                    <div class="text-[10px] font-mono uppercase opacity-50" x-text="toast.type === 'error' ? 'SYSTEM ERROR' : 'SUCCESS'"></div>
                    <div class="text-sm font-medium text-white/90" x-text="toast.message"></div>
                </div>
            </div>
        </template>
    </div>

    <div class="fixed inset-y-0 right-0 w-[450px] bg-[#0c0c0e]/95 backdrop-blur-xl border-l border-white/10 z-50 transform transition-transform duration-300 shadow-2xl flex flex-col"
         :class="chatOpen ? 'translate-x-0' : 'translate-x-full'" x-cloak>
        <div class="h-14 border-b border-white/10 flex items-center justify-between px-6 bg-black/20">
            <div class="flex items-center gap-2">
                <div class="w-1.5 h-1.5 bg-emerald-500 rounded-full shadow-[0_0_8px_#10B981]"></div>
                <span class="text-xs font-mono font-bold uppercase tracking-widest text-white/70">Bio-Architect</span>
            </div>
            <button @click="chatOpen = false" class="text-white/30 hover:text-white transition">✕</button>
        </div>
        <div class="flex-1 overflow-y-auto p-6 space-y-6 custom-scroll" id="chat-container">
            <div class="flex gap-4">
                <div class="w-8 h-8 rounded bg-white/5 border border-white/10 flex items-center justify-center flex-shrink-0 text-[10px] font-mono text-white/50">SYS</div>
                <div class="text-sm text-white/60 leading-relaxed py-1">System online. I have context on your biomarkers. How can I modify the protocol?</div>
            </div>
            <template x-for="msg in chatHistory">
                <div class="flex gap-4" :class="msg.role === 'user' ? 'flex-row-reverse' : ''">
                    <div class="w-8 h-8 rounded flex items-center justify-center flex-shrink-0 text-[10px] font-bold"
                         :class="msg.role === 'user' ? 'bg-amber-600 text-white' : 'bg-white/5 border border-white/10 text-white'">
                        <span x-text="msg.role === 'user' ? 'U' : 'AI'"></span>
                    </div>
                    <div class="text-sm leading-relaxed p-3 rounded-lg border max-w-[80%]"
                         :class="msg.role === 'user' ? 'bg-amber-500/10 border-amber-500/20 text-amber-50' : 'bg-white/5 border-white/5 text-white/80'">
                        <span x-text="msg.text"></span>
                    </div>
                </div>
            </template>
            <div x-show="chatLoading" class="text-xs font-mono text-amber-500 animate-pulse ml-12">Computing...</div>
        </div>
        <div class="p-4 border-t border-white/10 bg-black/20">
            <form @submit.prevent="sendMessage" class="relative">
                <input type="text" x-model="chatInput" placeholder="Type a command..."
                       class="w-full bg-[#151518] border border-white/10 rounded-lg px-4 py-3 text-sm font-mono text-white focus:outline-none focus:border-amber-500/50 placeholder-white/20">
                <button type="submit" class="absolute right-3 top-3 text-amber-500/50 hover:text-amber-500 transition-colors">↵</button>
            </form>
        </div>
    </div>

    <div x-show="recipeModalOpen" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" x-cloak>
        <div @click.outside="recipeModalOpen = false" class="glass-panel w-full max-w-3xl rounded-2xl relative flex flex-col max-h-[85vh] shadow-2xl border border-white/10">
            <div class="p-6 border-b border-white/10 flex justify-between items-start">
                <div>
                    <div class="text-[10px] font-mono text-amber-500 uppercase tracking-widest mb-1">Formulation</div>
                    <h2 class="text-2xl font-bold text-white" x-text="selectedMeal?.title"></h2>
                </div>
                <button @click="recipeModalOpen = false" class="w-8 h-8 rounded hover:bg-white/10 flex items-center justify-center text-white/50 hover:text-white transition">✕</button>
            </div>
            <div class="p-8 overflow-y-auto custom-scroll flex-1">
                <div x-show="!recipeDetails" class="py-12 flex flex-col items-center justify-center space-y-4">
                    <div class="w-8 h-8 border-2 border-amber-500 border-t-transparent rounded-full animate-spin"></div>
                    <div class="text-xs font-mono text-white/30">Compiling Data...</div>
                </div>
                <div x-show="recipeDetails" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="col-span-1 space-y-6">
                        <div class="p-4 rounded bg-white/5 border border-white/5 space-y-3">
                            <h4 class="text-[10px] font-mono text-white/40 uppercase">Macros</h4>
                            <div class="flex justify-between text-sm"><span class="text-white/60">Protein</span> <span class="font-mono" x-text="recipeDetails?.macros?.protein"></span></div>
                            <div class="flex justify-between text-sm"><span class="text-white/60">Carbs</span> <span class="font-mono" x-text="recipeDetails?.macros?.carbs"></span></div>
                            <div class="flex justify-between text-sm"><span class="text-white/60">Fats</span> <span class="font-mono" x-text="recipeDetails?.macros?.fats"></span></div>
                        </div>
                        <div class="p-4 rounded border border-amber-500/20 bg-amber-500/5">
                            <h4 class="text-[10px] font-mono text-amber-500 uppercase mb-2">Bio-Hack</h4>
                            <p class="text-xs text-amber-100/70 leading-relaxed" x-text="recipeDetails?.tips"></p>
                        </div>
                    </div>
                    <div class="col-span-2 space-y-4">
                        <h4 class="text-[10px] font-mono text-white/40 uppercase">Sequence</h4>
                        <template x-for="(step, i) in recipeDetails?.steps">
                            <div class="flex gap-4 p-3 rounded hover:bg-white/5 transition-colors border border-transparent hover:border-white/5">
                                <div class="font-mono text-amber-500/50 text-sm" x-text="'0' + (i+1)"></div>
                                <p class="text-sm text-white/80 leading-relaxed" x-text="step"></p>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div x-show="shoppingListOpen" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" x-cloak>
        <div @click.outside="shoppingListOpen = false" class="glass-panel w-full max-w-lg rounded-2xl relative max-h-[80vh] flex flex-col">
            <div class="p-6 border-b border-white/10 flex justify-between items-center">
                <h2 class="text-xl font-bold">Logistics</h2>
                <button @click="shoppingListOpen = false" class="text-white/50 hover:text-white">✕</button>
            </div>
            <div class="p-6 overflow-y-auto custom-scroll flex-1">
                 <div x-show="!shoppingList" class="py-8 text-center text-xs font-mono text-white/30 animate-pulse">Aggregating...</div>
                 <div x-show="shoppingList" class="space-y-6">
                    <template x-for="(items, category) in shoppingList">
                        <div>
                            <h3 class="text-xs font-bold font-mono text-amber-500 uppercase tracking-widest mb-3" x-text="category"></h3>
                            <div class="grid grid-cols-2 gap-2">
                                <template x-for="item in items">
                                    <div class="flex items-center gap-3 p-2 rounded bg-white/5 border border-white/5">
                                        <div class="w-1.5 h-1.5 bg-white/20 rounded-full"></div>
                                        <span class="text-xs text-white/70" x-text="item"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                 </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('app', () => ({
                token: localStorage.getItem('bio_token') || Math.random().toString(36).substring(7),
                context: null, weekPlan: [], chatHistory: [], toasts: [],
                loading: false, chatLoading: false, chatOpen: false,
                recipeModalOpen: false, shoppingListOpen: false, dragOver: false,
                selectedMeal: null, recipeDetails: null, shoppingList: null, chatInput: '',
                loadingText: 'Initializing...', loadingInterval: null,

                init() {
                    localStorage.setItem('bio_token', this.token);
                },

                notify(msg, type='success') {
                    const id = Date.now();
                    this.toasts.push({ id, message: msg, type });
                    setTimeout(() => { this.toasts = this.toasts.filter(t => t.id !== id) }, 4000);
                },

                startLoading(phases) {
                    this.loading = true;
                    let i = 0;
                    this.loadingText = phases[0];
                    this.loadingInterval = setInterval(() => {
                        i = (i + 1) % phases.length;
                        this.loadingText = phases[i];
                    }, 1200);
                },

                stopLoading() {
                    this.loading = false;
                    clearInterval(this.loadingInterval);
                },

                handleDrop(e) {
                    this.dragOver = false;
                    const file = e.dataTransfer.files[0];
                    if (file) this.uploadData(file);
                },

                async uploadData(file) {
                    if (!file) return;
                    this.startLoading(['Extracting Markers...', 'Parsing Lipid Panel...', 'Analyzing Hormones...', 'Compiling Strategy...']);

                    const fd = new FormData();
                    fd.append('file', file);
                    fd.append('token', this.token);

                    try {
                        const res = await fetch('/init_context', { method: 'POST', body: fd });
                        if(!res.ok) throw new Error();
                        this.context = await res.json();
                        this.notify("Biometric Analysis Complete");
                    } catch(e) {
                        this.notify("Analysis Failed. Check PDF format.", "error");
                    } finally {
                        this.stopLoading();
                    }
                },

                async generateWeek(strategy) {
                    this.startLoading(['Cross-referencing Database...', 'Optimizing for ' + strategy + '...', 'Calculating Macros...', 'Finalizing Protocol...']);
                    try {
                        const res = await fetch('/generate_week', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ strategy_name: strategy, token: this.token })
                        });
                        const data = await res.json();
                        this.weekPlan = Array.isArray(data) ? data : [];
                        this.notify("Protocol Generated Successfully");
                    } catch(e) {
                        this.notify("Protocol Generation Failed", "error");
                    } finally {
                        this.stopLoading();
                    }
                },

                async sendMessage() {
                    if(!this.chatInput.trim()) return;
                    const msg = this.chatInput;
                    this.chatHistory.push({ role: 'user', text: msg });
                    this.chatInput = '';
                    this.chatLoading = true;
                    this.scrollToBottom();

                    try {
                        const res = await fetch('/chat_agent', {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ message: msg, token: this.token })
                        });
                        const data = await res.json();
                        this.chatHistory.push({ role: 'ai', text: data.response });
                    } catch(e) {
                        this.chatHistory.push({ role: 'ai', text: "Connection interrupted." });
                    } finally {
                        this.chatLoading = false;
                        this.scrollToBottom();
                    }
                },

                scrollToBottom() {
                    this.$nextTick(() => {
                        const container = document.getElementById('chat-container');
                        container.scrollTop = container.scrollHeight;
                    });
                },

                async openRecipe(meal) {
                    this.selectedMeal = meal;
                    this.recipeDetails = null;
                    this.recipeModalOpen = true;
                    try {
                        const res = await fetch('/get_recipe', {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ meal_title: meal.title, token: this.token })
                        });
                        this.recipeDetails = await res.json();
                    } catch(e) { this.notify("Could not fetch recipe", "error"); }
                },

                async generateShoppingList() {
                    this.shoppingListOpen = true;
                    if(this.shoppingList) return;
                    try {
                        const res = await fetch('/generate_shopping_list', {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ token: this.token })
                        });
                        this.shoppingList = await res.json();
                    } catch(e) {}
                },

                async quickSwap(day, ing) {
                    this.chatOpen = true;
                    this.chatInput = `Override: ${ing} is not viable in ${day.title}. Request alternatives.`;
                    this.sendMessage();
                },

                resetSystem() {
                    if(confirm('Reboot System? Current data will be cleared.')) {
                        this.context = null;
                        this.weekPlan = [];
                        this.chatHistory = [];
                        this.notify("System Reset");
                    }
                }
            }))
        })
    </script>
</body>
</html>